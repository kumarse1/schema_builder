import streamlit as st
import pandas as pd
import json
import plotly.graph_objects as go
import networkx as nx
import os
from dotenv import load_dotenv
from gpt_text_generation_lib import GPTcustomLLM
from jwt_py_dev_utils import basicauthutil

# Load environment variables
load_dotenv()

# REST API credentials for LLM
REST_USERNAME = os.getenv('REST_USERNAME', '')
REST_PASSWORD = os.getenv('REST_PASSWORD', '')
LLM_MODEL = os.getenv('LLM_MODEL', 'Llama-3.2-90b-vision-instruct')

def get_llm_instance():
    """Initialize GPTcustomLLM with basic auth token"""
    if not REST_USERNAME or not REST_PASSWORD:
        return None
    token = "Basic " + basicauthutil().generate_basic_auth_token(REST_USERNAME, REST_PASSWORD)
    llm = GPTcustomLLM(model=LLM_MODEL, auth_token=token)
    return llm

def analyze_excel(file):
    """Analyze Excel file"""
    excel_file = pd.ExcelFile(file)
    nodes = [{"id": "0", "label": file.name, "level": 0, "type": "root", "details": f"Excel file with {len(excel_file.sheet_names)} sheets", "data": {}}]
    edges = []
    node_id = 1
    all_data = {}
    
    for sheet_name in excel_file.sheet_names[:10]:
        df = excel_file.parse(sheet_name)
        sheet_data = {"rows": len(df), "columns": list(df.columns), "preview": df.head(5).to_dict('records') if len(df) > 0 else []}
        all_data[sheet_name] = sheet_data
        
        sheet_id = str(node_id)
        nodes.append({"id": sheet_id, "label": sheet_name, "level": 1, "type": "sheet", "details": f"Sheet with {len(df)} rows and {len(df.columns)} columns", "data": sheet_data})
        edges.append({"source": "0", "target": sheet_id})
        node_id += 1
        
        for col in df.columns[:5]:
            col_id = str(node_id)
            col_info = {"type": str(df[col].dtype), "non_null": int(df[col].count()), "unique": int(df[col].nunique()), "sample": df[col].dropna().head(3).tolist() if len(df[col].dropna()) > 0 else []}
            nodes.append({"id": col_id, "label": col, "level": 2, "type": "column", "details": f"Type: {col_info['type']}, Non-null: {col_info['non_null']}, Unique: {col_info['unique']}", "data": col_info})
            edges.append({"source": sheet_id, "target": col_id})
            node_id += 1
    
    return {"nodes": nodes, "edges": edges, "full_data": all_data, "filename": file.name}

def chat_with_llm(question, context, conversation_history):
    """Chat with custom LLM"""
    llm = get_llm_instance()
    if not llm:
        return "‚ö†Ô∏è REST_USERNAME/REST_PASSWORD not configured in .env"
    
    try:
        conversation_text = ""
        for msg in conversation_history[-6:]:
            role = "User" if msg['role'] == 'user' else "Assistant"
            conversation_text += f"\n{role}: {msg['content']}"
        
        full_prompt = f"""You are analyzing an Excel file mind map.

Context: {json.dumps(context, indent=2)}

Previous conversation:{conversation_text}

User: {question}

Please provide a clear and concise answer."""
        
        response = llm.generate(full_prompt)
        return response
    except Exception as e:
        return f"Error: {str(e)}"

def visualize(mindmap_data):
    """Create interactive visualization"""
    G = nx.Graph()
    node_info = {}
    for node in mindmap_data['nodes']:
        G.add_node(node['id'], **node)
        node_info[node['id']] = node
    
    for edge in mindmap_data['edges']:
        G.add_edge(edge['source'], edge['target'])
    
    pos = nx.spring_layout(G, k=2, iterations=50)
    
    edge_x, edge_y = [], []
    for edge in G.edges():
        x0, y0 = pos[edge[0]]
        x1, y1 = pos[edge[1]]
        edge_x.extend([x0, x1, None])
        edge_y.extend([y0, y1, None])
    
    edge_trace = go.Scatter(x=edge_x, y=edge_y, line=dict(width=2, color='#888'), mode='lines', hoverinfo='none')
    
    node_x, node_y, node_text, node_color, node_ids = [], [], [], [], []
    for node_id in G.nodes():
        x, y = pos[node_id]
        node = G.nodes[node_id]
        node_x.append(x)
        node_y.append(y)
        node_text.append(node['label'])
        node_ids.append(node_id)
        level = node['level']
        colors = ['#FF6B6B', '#4ECDC4', '#95E1D3']
        node_color.append(colors[level] if level < len(colors) else '#95E1D3')
    
    node_trace = go.Scatter(x=node_x, y=node_y, mode='markers+text', text=node_text, textposition="top center", marker=dict(color=node_color, size=35, line=dict(width=2, color='white')), customdata=node_ids, hovertemplate='<b>%{text}</b><br>Click to view details<extra></extra>')
    
    fig = go.Figure(data=[edge_trace, node_trace], layout=go.Layout(title=f'Interactive Mind Map - {LLM_MODEL}', showlegend=False, xaxis=dict(showgrid=False, zeroline=False, showticklabels=False), yaxis=dict(showgrid=False, zeroline=False, showticklabels=False), height=700, clickmode='event+select'))
    
    return fig, node_info

def main():
    st.set_page_config(page_title="Mind Map POC", page_icon="üß†", layout="wide")
    
    # Initialize session state
    if 'chat_history' not in st.session_state:
        st.session_state.chat_history = []
    if 'selected_node' not in st.session_state:
        st.session_state.selected_node = None
    
    # Header
    st.title("üß† Interactive Mind Map POC")
    st.markdown(f"**LLM:** {LLM_MODEL}")
    
    if not REST_USERNAME or not REST_PASSWORD:
        st.error("‚ö†Ô∏è REST_USERNAME/REST_PASSWORD not set in .env")
    else:
        st.success("‚úÖ LLM Ready")
    
    st.markdown("---")
    
    # Upload
    uploaded_file = st.file_uploader("üìÅ Upload Excel File", type=['xlsx', 'xls'])
    
    if uploaded_file:
        if 'mindmap' not in st.session_state or st.session_state.get('last_file') != uploaded_file.name:
            with st.spinner("Analyzing..."):
                mindmap_data = analyze_excel(uploaded_file)
                st.session_state['mindmap'] = mindmap_data
                st.session_state['last_file'] = uploaded_file.name
                st.session_state.chat_history = []
            st.success(f"‚úÖ Loaded: {uploaded_file.name}")
    
    # Main content
    if 'mindmap' in st.session_state:
        mindmap_data = st.session_state['mindmap']
        left_col, right_col = st.columns([1, 2])
        
        with right_col:
            st.subheader("üó∫Ô∏è Mind Map")
            fig, node_info = visualize(mindmap_data)
            st.plotly_chart(fig, use_container_width=True, key="mindmap_plot")
            st.info("üí° Click nodes to view details")
            
            with st.expander("Manual Selection"):
                node_names = {node['id']: node['label'] for node in mindmap_data['nodes']}
                selected_id = st.selectbox("Choose node", options=list(node_names.keys()), format_func=lambda x: node_names[x])
                if st.button("Load Node"):
                    st.session_state.selected_node = selected_id
                    st.rerun()
        
        with left_col:
            st.subheader("üìã Details & Chat")
            
            if st.session_state.selected_node:
                node = next((n for n in mindmap_data['nodes'] if n['id'] == st.session_state.selected_node), None)
                
                if node:
                    st.markdown(f"### üìå {node['label']}")
                    st.markdown(f"**Type:** `{node['type']}`")
                    st.markdown(f"**Details:** {node['details']}")
                    
                    if node.get('data'):
                        with st.expander("üìä Data"):
                            st.json(node['data'])
                    
                    st.markdown("---")
                    st.markdown("### üí¨ Chat")
                    
                    chat_container = st.container(height=300)
                    with chat_container:
                        for msg in st.session_state.chat_history:
                            if msg['role'] == 'user':
                                st.markdown(f"**You:** {msg['content']}")
                            else:
                                st.markdown(f"**AI:** {msg['content']}")
                    
                    question = st.text_input("Ask question", placeholder=f"What's in {node['label']}?", key="chat_input")
                    
                    col1, col2 = st.columns([3, 1])
                    with col1:
                        if st.button("üí¨ Send", type="primary", use_container_width=True):
                            if question:
                                context = {"selected_node": node, "filename": mindmap_data['filename'], "full_data": mindmap_data.get('full_data', {})}
                                with st.spinner("Thinking..."):
                                    response = chat_with_llm(question, context, st.session_state.chat_history)
                                st.session_state.chat_history.append({"role": "user", "content": question})
                                st.session_state.chat_history.append({"role": "assistant", "content": response})
                                st.rerun()
                    
                    with col2:
                        if st.button("üóëÔ∏è", use_container_width=True):
                            st.session_state.chat_history = []
                            st.rerun()
                    
                    st.markdown("##### Quick Questions:")
                    quick = [f"What is {node['label']}?", "Summarize", "Key insights", "Explain structure"]
                    cols = st.columns(2)
                    for idx, q in enumerate(quick):
                        with cols[idx % 2]:
                            if st.button(q, key=f"q_{idx}", use_container_width=True):
                                context = {"selected_node": node, "filename": mindmap_data['filename'], "full_data": mindmap_data.get('full_data', {})}
                                with st.spinner("..."):
                                    response = chat_with_llm(q, context, st.session_state.chat_history)
                                st.session_state.chat_history.append({"role": "user", "content": q})
                                st.session_state.chat_history.append({"role": "assistant", "content": response})
                                st.rerun()
            else:
                st.info("üëÜ Click a node to start")
                st.markdown(f"**File:** {mindmap_data['filename']}")
                st.markdown(f"**Nodes:** {len(mindmap_data['nodes'])}")
        
        st.markdown("---")
        col1, col2 = st.columns(2)
        with col1:
            st.download_button("üì• Mind Map JSON", json.dumps(mindmap_data, indent=2), f"{mindmap_data['filename']}_mindmap.json", "application/json", use_container_width=True)
        with col2:
            if st.session_state.chat_history:
                chat_export = "\n\n".join([f"{'You' if msg['role'] == 'user' else 'AI'}: {msg['content']}" for msg in st.session_state.chat_history])
                st.download_button("üì• Chat History", chat_export, "chat.txt", "text/plain", use_container_width=True)

if __name__ == "__main__":
    main()
